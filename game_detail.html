{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ game.title }}</title>
    <link rel="stylesheet" href="{% static 'catalog/main.css' %}">
</head>
<body>
    <div class="game-detail-container">
        <div style="display:flex;align-items:center;justify-content:center;gap:16px;">
            <h2 style="margin-bottom:0;">{{ game.title }}</h2>
            {% if user.is_authenticated %}
                {% if game.id in favorites %}
                    <a href="/remove-favorite/{{ game.id }}/" class="fav-toggle" title="–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" style="font-size:2em;color:#ffb300;">‚òÖ</a>
                {% else %}
                    <a href="/add-favorite/{{ game.id }}/" class="fav-toggle" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" style="font-size:2em;color:#ffe0a3;">‚òÜ</a>
                {% endif %}
                {% if user.is_superuser %}
                    <a href="{% url 'upload_torrent' %}" class="btn" style="margin-left:18px;padding:8px 18px;background:#ffb300;color:#23283a;border-radius:8px;font-weight:600;text-decoration:none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ä—Ä–µ–Ω—Ç</a>
                {% endif %}
            {% endif %}
        </div>
        {% if game.cover_image %}
            <img src="{{ game.cover_image.url }}" alt="–û–±–ª–æ–∂–∫–∞" class="cover-img">
        {% endif %}
        <div class="game-info">
            <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>
            {{ game.description }}
        </div>
        <div class="game-tags">
            <strong>–¢–µ–≥–∏:</strong>
            {% for tag in game.tags.all %}
                <span>{{ tag.name }}</span>
            {% empty %}
                <span style="background:#888;">–ù–µ—Ç —Ç–µ–≥–æ–≤</span>
            {% endfor %}
        </div>
        <div>
            <strong>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞:</strong> {{ game.release_date }}
        </div>
        <div class="torrent-list">
            <strong>–¢–æ—Ä—Ä–µ–Ω—Ç—ã:</strong>
            <ul>
                {% for torrent in torrents %}
                    <li>
                        <a href="{{ torrent.file.url }}">–°–∫–∞—á–∞—Ç—å —Ç–æ—Ä—Ä–µ–Ω—Ç</a>
                        (–∑–∞–≥—Ä—É–∑–∏–ª: {{ torrent.uploaded_by }})
                    </li>
                {% empty %}
                    <li>–ù–µ—Ç —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤</li>
                {% endfor %}
            </ul>
        </div>
        <hr style="margin:32px 0 18px 0; border:0; border-top:1px solid #444;">
        <div class="comments-section" style="background:#23283a;border-radius:12px;padding:24px 24px 18px 24px;box-shadow:0 2px 8px #0002;max-width:600px;margin:32px auto;">
            {% if comments %}
                <ul class="comment-list">
                    {% for comment in comments %}
                        <li class="comment-item">
                            <div class="comment-text">{{ comment.text|linebreaksbr }}</div>
                            <div class="comment-meta">
                                <b>{{ comment.user.username }}</b> ‚Ä¢ {{ comment.created_at|date:'d.m.Y H:i' }}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="comment-empty">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
            {% endif %}

            {% if user.is_authenticated %}
                <form method="post" class="comment-form-inline">
                    {% csrf_token %}
                    {% if comment_success %}
                        <div class="comment-success">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!</div>
                    {% endif %}
                    {% if comment_error %}
                        <div class="comment-error">{{ comment_error }}</div>
                    {% endif %}
                    <div class="comment-input-row">
                        <input type="text" name="comment_text" class="comment-input" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required>
                        <button type="button" class="emoji-btn" id="emoji-btn" title="–°–º–∞–π–ª–∏–∫–∏">üòä</button>
                        <button type="submit" class="comment-send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="#4fc3f7"/><path d="M8 12h8M16 12l-4-4m4 4l-4 4" stroke="#23283a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <div class="emoji-panel" id="emoji-panel">
                            <span>üòÄ</span><span>ÔøΩ</span><span>üòé</span><span>ÔøΩ</span><span>ü§î</span><span>üëç</span><span>üëé</span><span>üéÆ</span><span>üî•</span><span>‚ù§Ô∏è</span>
                        </div>
                    </div>
                </form>
            {% else %}
                <div class="comment-login">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</div>
            {% endif %}
        </div>
        <a href="/" class="back-link">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
        <script>
            // Emoji panel logic
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPanel = document.getElementById('emoji-panel');
            const textarea = document.querySelector('textarea[name="comment_text"]');
            emojiBtn.addEventListener('click', function(e) {
                emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'block' : 'none';
            });
            emojiPanel.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('emoji-choice')) {
                    // –í—Å—Ç–∞–≤–∫–∞ emoji –≤ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ –∫—É—Ä—Å–æ—Ä–∞
                    const emoji = e.target.textContent;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = textarea.value;
                    textarea.value = text.slice(0, start) + emoji + text.slice(end);
                    textarea.focus();
                    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
                    emojiPanel.style.display = 'none';
                    e.preventDefault();
                }
            });
            // –°–∫—Ä—ã–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('mousedown', function(e) {
                if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                    emojiPanel.style.display = 'none';
                }
            });
        </script>
</body>
</html>
